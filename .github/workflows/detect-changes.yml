name: Detect Changes and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment (api, frontend, or both)'
        required: false
        type: choice
        options:
          - none
          - api
          - frontend
          - both

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      frontend: ${{ steps.filter.outputs.frontend }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/shared/**'
              - '.github/workflows/deploy-api.yml'
              - 'package.json'
            frontend:
              - 'apps/frontend/**'
              - 'packages/shared/**'
              - '.github/workflows/deploy-frontend.yml'
              - 'package.json'
            shared:
              - 'packages/shared/**'
      
      - name: Summary
        run: |
          echo "## Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "- **API Changed**: ${{ steps.filter.outputs.api }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Changed**: ${{ steps.filter.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Shared Changed**: ${{ steps.filter.outputs.shared }}" >> $GITHUB_STEP_SUMMARY

  deploy-api:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.api == 'true' || 
      github.event.inputs.force_deploy == 'api' || 
      github.event.inputs.force_deploy == 'both'
    uses: ./.github/workflows/deploy-api.yml
    secrets: inherit

  deploy-frontend:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.frontend == 'true' || 
      github.event.inputs.force_deploy == 'frontend' || 
      github.event.inputs.force_deploy == 'both'
    uses: ./.github/workflows/deploy-frontend.yml
    secrets: inherit