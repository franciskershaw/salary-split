name: Deploy API to Digital Ocean

on:
  workflow_call:
  workflow_dispatch:

env:
  DOCKER_IMAGE: docker.io/${{ secrets.DOCKER_USERNAME }}/salary-split-api
  DOMAIN: api.salarysplit.co.uk
  CONTAINER_NAME: salary-split-api
  NGINX_PATH: /etc/nginx/sites-available
  PORT: 5300

jobs:
  build:
    runs-on: ubuntu-latest
    environment:
      name: Production
      url: https://${{ env.DOMAIN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        timeout-minutes: 5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Tag current production as previous (rollback point)
        id: backup
        continue-on-error: true
        run: |
          if docker pull ${{ env.DOCKER_IMAGE }}:latest; then
            echo "âœ… Previous version exists, creating backup tag"
            docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_IMAGE }}:previous
            docker push ${{ env.DOCKER_IMAGE }}:previous
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No previous version found, skipping backup"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: |
            type=gha
            type=registry,ref=${{ env.DOCKER_IMAGE }}:latest
          cache-to: type=gha,mode=max
        timeout-minutes: 15

      - name: Build Summary
        run: |
          echo "### ðŸ³ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.DOCKER_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Rollback Available**: ${{ steps.backup.outputs.available }}" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: Production
      url: https://${{ env.DOMAIN }}
    concurrency:
      group: production-api
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy Nginx configuration
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          source: "apps/api/nginx/salary-split-api.conf"
          target: "/home/${{ secrets.DO_USERNAME }}/nginx/"
          strip_components: 2
          timeout: 30s

      - name: Configure Nginx and SSL
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          timeout: 2m
          script: |
            echo "ðŸ”§ Starting nginx configuration..."
            SITE_CONFIG="${{ env.NGINX_PATH }}/${{ env.DOMAIN }}"

            if [ -f "$SITE_CONFIG" ]; then
              if grep -q "ssl_certificate" "$SITE_CONFIG"; then
                echo "âœ… SSL configuration exists, preserving current nginx config"
                exit 0
              fi
            fi

            echo "ðŸ“ Setting up new nginx config..."
            NGINX_SOURCE="/home/${{ secrets.DO_USERNAME }}/nginx/salary-split-api.conf"
            
            if [ ! -f "$NGINX_SOURCE" ]; then
              echo "âŒ Error: nginx configuration file not found"
              exit 1
            fi

            sudo mv "$NGINX_SOURCE" "$SITE_CONFIG"
            sudo ln -sf "$SITE_CONFIG" "/etc/nginx/sites-enabled/"

            echo "ðŸ§ª Testing nginx configuration..."
            sudo nginx -t

            if [ ! -f "/etc/letsencrypt/live/${{ env.DOMAIN }}/fullchain.pem" ]; then
              echo "ðŸ”’ Setting up SSL certificate..."
              sudo certbot --nginx -d ${{ env.DOMAIN }} \
                --nginx-server-root /etc/nginx/ \
                --non-interactive \
                --agree-tos \
                --email ${{ secrets.CERTBOT_EMAIL }} \
                --redirect
            fi
            
            echo "â™»ï¸ Reloading nginx..."
            sudo systemctl reload nginx

      - name: Deploy Docker Container (Blue-Green)
        id: deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          timeout: 5m
          script: |
            echo "ðŸš€ Starting deployment..."

            # Keep old container as backup
            if docker ps -a | grep -q "${{ env.CONTAINER_NAME }}$"; then
              echo "ðŸ“¦ Renaming old container to backup..."
              docker rename ${{ env.CONTAINER_NAME }} ${{ env.CONTAINER_NAME }}-backup || true
            fi

            echo "â¬‡ï¸ Pulling latest image..."
            docker pull ${{ env.DOCKER_IMAGE }}:latest

            echo "ðŸ†• Starting new container..."
            docker run -d \
              --name ${{ env.CONTAINER_NAME }}-new \
              --restart unless-stopped \
              --health-cmd="curl -f http://localhost:${{ env.PORT }} || exit 1" \
              --health-interval=30s \
              --health-timeout=5s \
              --health-retries=3 \
              -p ${{ env.PORT }}:${{ env.PORT }} \
              -e NODE_ENV=production \
              -e PORT=${{ env.PORT }} \
              -e MONGO_URI='${{ secrets.MONGO_URI }}' \
              -e CORS_ORIGIN='${{ secrets.CORS_ORIGIN }}' \
              -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
              -e JWT_REFRESH_SECRET='${{ secrets.JWT_REFRESH_SECRET }}' \
              -e GOOGLE_CLIENT_ID='${{ secrets.GOOGLE_CLIENT_ID }}' \
              -e GOOGLE_CLIENT_SECRET='${{ secrets.GOOGLE_CLIENT_SECRET }}' \
              -e GOOGLE_REDIRECT_URI='${{ secrets.GOOGLE_REDIRECT_URI }}' \
              ${{ env.DOCKER_IMAGE }}:latest

            echo "â³ Waiting for container to start..."
            sleep 15

            if ! docker ps | grep -q "${{ env.CONTAINER_NAME }}-new"; then
              echo "âŒ Container failed to start"
              docker logs ${{ env.CONTAINER_NAME }}-new
              exit 1
            fi

      - name: Health Check
        id: health_check
        uses: appleboy/ssh-action@master
        continue-on-error: true
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          timeout: 2m
          script: |
            echo "ðŸ¥ Running health checks..."
            HEALTH_CHECK_ATTEMPTS=0
            MAX_ATTEMPTS=20

            until [ $HEALTH_CHECK_ATTEMPTS -eq $MAX_ATTEMPTS ] || curl -sf http://localhost:${{ env.PORT }} > /dev/null; do
              echo "Attempt $((HEALTH_CHECK_ATTEMPTS + 1))/$MAX_ATTEMPTS"
              HEALTH_CHECK_ATTEMPTS=$((HEALTH_CHECK_ATTEMPTS + 1))
              sleep 3
            done

            if [ $HEALTH_CHECK_ATTEMPTS -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
              docker logs ${{ env.CONTAINER_NAME }}-new
              exit 1
            fi

            echo "âœ… Container is healthy!"

      - name: Finalize Deployment
        if: steps.health_check.outcome == 'success'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            echo "âœ… Finalizing deployment..."
            
            # Stop and remove backup container
            if docker ps -a | grep -q "${{ env.CONTAINER_NAME }}-backup"; then
              docker stop ${{ env.CONTAINER_NAME }}-backup || true
              docker rm ${{ env.CONTAINER_NAME }}-backup || true
            fi

            # Promote new container to production
            docker rename ${{ env.CONTAINER_NAME }}-new ${{ env.CONTAINER_NAME }}
            
            echo "ðŸŽ‰ Deployment complete!"

      - name: Rollback on Failure
        if: steps.health_check.outcome == 'failure'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            echo "âš ï¸ INITIATING ROLLBACK..."
            
            # Stop and remove failed container
            docker stop ${{ env.CONTAINER_NAME }}-new || true
            docker rm ${{ env.CONTAINER_NAME }}-new || true
            
            # Restore backup if it exists
            if docker ps -a | grep -q "${{ env.CONTAINER_NAME }}-backup"; then
              echo "â™»ï¸ Restoring previous version..."
              docker rename ${{ env.CONTAINER_NAME }}-backup ${{ env.CONTAINER_NAME }}
              
              # Start the backup container if it's not running
              if ! docker ps | grep -q "${{ env.CONTAINER_NAME }}$"; then
                docker start ${{ env.CONTAINER_NAME }}
              fi
              
              echo "âœ… Rollback complete - previous version restored"
            else
              echo "âš ï¸ No backup container found"
            fi

      - name: Deployment Summary
        if: always()
        run: |
          if [ "${{ steps.health_check.outcome }}" == "success" ]; then
            echo "### âœ… API Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
            echo "- **URL**: https://${{ env.DOMAIN }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Container**: \`${{ env.CONTAINER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Image**: \`${{ env.DOCKER_IMAGE }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ API Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: Rolled back to previous version" >> $GITHUB_STEP_SUMMARY
            echo "- **Action**: Check logs and retry deployment" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail workflow if health check failed
        if: steps.health_check.outcome == 'failure'
        run: exit 1